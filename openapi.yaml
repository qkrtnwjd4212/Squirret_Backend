openapi: 3.0.3
info:
  title: Squirret Backend API
  version: 2.0.0
  description: |
    Squirret 백엔드 API 명세 (게스트 모드)
    모든 API는 현재 공개적으로 접근 가능합니다.
  contact:
    name: Squirret Team

servers:
  - url: http://54.86.161.187:8080
    description: Production server
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Guest
    description: 게스트 세션 관리
  - name: Session
    description: 세션 및 인증 관리
  - name: FSR
    description: FSR(깔창) 데이터 관리
  - name: Inference
    description: AI 추론 세션 관리
  - name: Internal
    description: 내부 API

paths:
  # ============================================
  # 게스트 세션 관리
  # ============================================
  /api/guest/:
    get:
      tags: [Guest]
      summary: 서버 상태 확인
      responses:
        '200':
          description: 성공
          content:
            text/plain:
              schema:
                type: string
                example: "Squirret Backend API Server - Guest Mode"

  /api/guest/session:
    post:
      tags: [Guest]
      summary: 게스트 세션 생성
      description: 클라이언트가 처음 접속할 때 호출하여 게스트 ID를 발급받습니다.
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuestSessionResponse'

  /api/guest/session/{guestId}:
    get:
      tags: [Guest]
      summary: 게스트 세션 조회
      parameters:
        - name: guestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuestSessionInfo'
        '400':
          description: 유효하지 않은 게스트 ID 형식
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/guest/health:
    get:
      tags: [Guest]
      summary: 헬스 체크
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  mode:
                    type: string
                    example: "guest"

  # ============================================
  # 세션/인증 API
  # ============================================
  /internal/session:
    post:
      tags: [Session]
      summary: 게스트 세션 발급
      description: 게스트 세션 ID와 WebSocket 토큰을 발급받습니다.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionIssueResponse'

  # ============================================
  # AI 추론 세션 관리
  # ============================================
  /api/session:
    post:
      tags: [Inference]
      summary: FastAPI 세션 등록
      description: 프론트에서 발급받은 FastAPI 세션 ID를 백엔드에 등록합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterSessionRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InferenceSessionResponse'
        '400':
          description: 잘못된 요청 (fastApiSessionId 누락)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/session/{sessionId}/finish:
    post:
      tags: [Inference]
      summary: 세션 완료
      description: 추론 세션을 완료하고 통계를 저장합니다.
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Spring 세션 ID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionFinishRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionFinishResponse'

  /api/internal/inference/{fastApiSessionId}/feedback:
    post:
      tags: [Internal]
      summary: FastAPI 피드백 수신 (내부)
      description: FastAPI에서 분석 결과/피드백을 받아서 앱으로 전달합니다.
      parameters:
        - name: fastApiSessionId
          in: path
          required: true
          schema:
            type: string
          description: FastAPI 세션 ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InferenceFeedbackRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResponse'
        '400':
          description: 세션을 찾을 수 없거나 피드백 전달 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # FSR 데이터 API
  # ============================================
  /api/fsr_data:
    post:
      tags: [FSR]
      summary: FSR 데이터 업로드
      description: ESP32에서 FSR(깔창) 데이터를 업로드합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FSRDataRequest'
      responses:
        '202':
          description: 수락됨
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ACCEPTED"
        '400':
          description: 검증 실패 (ratio1~6이 0~100 범위를 벗어남)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/fsr_data/latest:
    get:
      tags: [FSR]
      summary: 최신 FSR 스냅샷 조회
      description: 양발의 최신 FSR 데이터를 조회합니다.
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FSRLatestResponse'

  /api/fsr_data/feedback:
    get:
      tags: [FSR]
      summary: FSR 피드백 조회
      description: 10초 구간의 FSR 데이터를 기반으로 자세 피드백을 제공합니다.
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FSRFeedbackResponse'

  /api/fsr_data/feedback/combined:
    get:
      tags: [FSR]
      summary: AI + FSR 통합 피드백 조회
      description: AI 상태와 FSR 데이터를 통합한 피드백을 제공합니다.
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombinedFeedbackResponse'

  # ============================================
  # 내부 API
  # ============================================
  /internal/ai/status:
    post:
      tags: [Internal]
      summary: AI 상태 입력 (내부)
      description: AI 분석 결과 상태를 입력합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIStatusRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        '400':
          description: 잘못된 상태 값
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # 게스트 세션
    GuestSessionResponse:
      type: object
      properties:
        guestId:
          type: string
          format: uuid
          description: 게스트 ID
        message:
          type: string
          example: "게스트 세션이 생성되었습니다."

    GuestSessionInfo:
      type: object
      properties:
        guestId:
          type: string
          format: uuid
        valid:
          type: boolean
        message:
          type: string
          example: "유효한 게스트 세션입니다."

    # 세션 발급
    SessionIssueResponse:
      type: object
      properties:
        sessionId:
          type: string
          format: uuid
          description: 세션 ID
        wsToken:
          type: string
          description: WebSocket 토큰 (현재는 placeholder)

    # 추론 세션
    RegisterSessionRequest:
      type: object
      required: [fastApiSessionId]
      properties:
        userId:
          type: string
          description: 게스트 ID (선택사항, 기본값: "guest")
        fastApiSessionId:
          type: string
          description: FastAPI에서 발급받은 세션 ID (필수)
          example: "session_7f83a1f3"

    InferenceSessionResponse:
      type: object
      properties:
        sessionId:
          type: string
          format: uuid
          description: Spring 세션 ID (백엔드 내부 관리용)
        fastApiUrl:
          type: string
          nullable: true
          description: 더 이상 사용하지 않음
        fastApiSessionId:
          type: string
          description: FastAPI 세션 ID

    SessionFinishRequest:
      type: object
      properties:
        framesIn:
          type: integer
          description: 입력 프레임 수
        framesOut:
          type: integer
          description: 출력 프레임 수
        durationSeconds:
          type: integer
          description: 세션 지속 시간 (초)

    SessionFinishResponse:
      type: object
      properties:
        status:
          type: string
          example: "completed"
        sessionId:
          type: string
          format: uuid

    # 피드백
    InferenceFeedbackRequest:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [analysis]
        frameNumber:
          type: integer
        state:
          type: string
          enum: [SIT, STAND]
        side:
          type: string
          enum: [left, right]
        squatCount:
          type: integer
        checks:
          type: object
          properties:
            back:
              type: string
              enum: [good, bad, too forward]
            knee:
              type: string
              enum: [good, bad, too forward]
            ankle:
              type: string
              enum: [good, bad]
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp (밀리초)

    FeedbackResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        springSessionId:
          type: string
          format: uuid
        fastApiSessionId:
          type: string
        message:
          type: string
          example: "피드백이 앱으로 전달되었습니다."

    # FSR 데이터
    FSRDataRequest:
      type: object
      required: [side, ratio1, ratio2, ratio3, ratio4, ratio5, ratio6]
      properties:
        side:
          type: string
          enum: [left, right]
        ratio1:
          type: number
          format: double
          minimum: 0
          maximum: 100
        ratio2:
          type: number
          format: double
          minimum: 0
          maximum: 100
        ratio3:
          type: number
          format: double
          minimum: 0
          maximum: 100
        ratio4:
          type: number
          format: double
          minimum: 0
          maximum: 100
        ratio5:
          type: number
          format: double
          minimum: 0
          maximum: 100
        ratio6:
          type: number
          format: double
          minimum: 0
          maximum: 100

    FSRFoot:
      type: object
      properties:
        side:
          type: string
          enum: [left, right]
        ratio1:
          type: number
          format: double
        ratio2:
          type: number
          format: double
        ratio3:
          type: number
          format: double
        ratio4:
          type: number
          format: double
        ratio5:
          type: number
          format: double
        ratio6:
          type: number
          format: double

    FSRLatestResponse:
      type: object
      properties:
        left:
          $ref: '#/components/schemas/FSRFoot'
          nullable: true
        right:
          $ref: '#/components/schemas/FSRFoot'
          nullable: true

    FSRFeedbackResponse:
      type: object
      properties:
        stage:
          type: string
          enum: [DESCENT, ASCENT, UNKNOWN]
          nullable: true
        status:
          type: string
          enum: [GOOD, BAD, NO_DATA]
          nullable: true
        feedback:
          type: string
          nullable: true
        metrics:
          type: object
          nullable: true
          additionalProperties:
            type: number
            format: double
          properties:
            front:
              type: number
              format: double
            rear:
              type: number
              format: double
            inner:
              type: number
              format: double
            outer:
              type: number
              format: double
            heel:
              type: number
              format: double
            innerOuterDiff:
              type: number
              format: double
            leftRightDiff:
              type: number
              format: double

    CombinedFeedbackResponse:
      type: object
      properties:
        ai:
          type: object
          properties:
            status:
              type: string
            raw:
              type: object
              nullable: true
              additionalProperties:
                type: string
            messages:
              type: array
              items:
                type: string
              nullable: true
        fsr:
          type: object
          nullable: true
          properties:
            stage:
              type: string
              enum: [DESCENT, ASCENT, UNKNOWN]
              nullable: true
            status:
              type: string
              enum: [GOOD, BAD, NO_DATA]
              nullable: true
            feedback:
              type: string
              nullable: true
            metrics:
              type: object
              nullable: true
              additionalProperties:
                type: number
                format: double
        overallMessages:
          type: array
          items:
            type: string

    # AI 상태
    AIStatusRequest:
      type: object
      properties:
        lumbar:
          type: string
          enum: [good, bad, null]
          nullable: true
        knee:
          type: string
          enum: [good, bad, null]
          nullable: true
        ankle:
          type: string
          enum: [good, bad, null]
          nullable: true

    # 에러 응답
    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        status:
          type: integer
        error:
          type: string
        code:
          type: string
        message:
          type: string
        path:
          type: string
